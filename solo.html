<!doctype html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Solo</title>
    <link rel="icon" type="image/png" sizes="64x64" href="./favicon.png">
    <!-- Charger la biblioth√®que Phaser pour cr√©er des jeux 2D -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
</head>
<style>
    /* Supprimer les marges par d√©faut du navigateur */
    body {
        margin: 0;
        background-color: rgb(65, 61, 61);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    /* Le jeu */
    canvas {
        border: 4px solid rgb(41, 21, 21);
    }
</style>

<body>

    <img src="assets/logohome.png" alt="Home"
        style="cursor:pointer; width:105px; position: fixed; top: 10px; left: 10px;"
        onclick="window.location.href='./index.html'">
    <img src="assets/logoretour.png" alt="Retour"
        style="cursor:pointer; width:105px; position: fixed; top: 10px; left: 125px;"
        onclick="window.location.href='./index.html'">
    <img src="assets/logorefresh.png" alt="Actualiser"
        style="cursor:pointer; width:105px; position: fixed; top: 10px; right: 10px;"
        onclick="window.location.href='./solo.html'">

    <div id="game-wrapper" class="game-wrapper"></div>

    <script>
        // Configuration du jeu Phaser
        var config = {
            type: Phaser.AUTO, // Type de rendu automatique
            width: 800, // Largeur de la fen√™tre de jeu
            height: 600, // Hauteur de la fen√™tre de jeu
            physics: {
                default: 'arcade', // Moteur physique arcade
                arcade: {
                    gravity: { y: 300 }, // Gravit√© appliqu√©e aux objets
                    debug: false // Mode d√©bogage d√©sactiv√©
                }
            },
            scene: { preload, create, update } // Fonctions principales du jeu
        };

        // Cr√©er une nouvelle instance du jeu
        new Phaser.Game(config);

        // ===== Variables globales du jeu =====
        var player; // Le personnage principal
        var cursors; // Les touches du clavier
        var stars; // Les √©toiles √† collecter
        var bombs; // Les bombes √† √©viter
        var platforms; // Les plateformes sur lesquelles marcher
        var score = 0, scoreText; // Score et affichage du score
        var lives = 3, lifeIcons = []; // Nombre de vies et ic√¥nes de vie
        var gameOver = false; // √âtat du jeu

        // Variables pour g√©rer les niveaux
        var currentLevel = 0; // Niveau actuel
        var platformsArray = []; // Tableau des plateformes du niveau
        var tremplin = null; // Le tremplin

        // Diff√©rentes dispositions de plateformes pour chaque niveau
        var platformLayouts = [
            [{ x: 600, y: 400 }, { x: 50, y: 250 }, { x: 750, y: 220 }],
            [{ x: 150, y: 350 }, { x: 400, y: 200 }, { x: 650, y: 300 }, { x: 400, y: 470 }],
            [{ x: 700, y: 250 }, { x: 80, y: 150 }, { x: 500, y: 400 }],
            [{ x: 300, y: 420 }, { x: 40, y: 200 }, { x: 650, y: 120 }, { x: 400, y: 300 }],
            [{ x: 200, y: 380 }, { x: 40, y: 140 }, { x: 600, y: 240 }, { x: 350, y: 100 }],
            [{ x: 200, y: 150 }, { x: 500, y: 310 }, { x: 700, y: 180 }, { x: 350, y: 460 }],
            [{ x: 100, y: 380 }, { x: 300, y: 250 }, { x: 500, y: 150 }, { x: 700, y: 250 }],
            [{ x: 50, y: 380 }, { x: 250, y: 200 }, { x: 450, y: 100 }, { x: 650, y: 200 }],
            [{ x: 400, y: 380 }, { x: 200, y: 250 }, { x: 600, y: 150 }],
            [{ x: 100, y: 500 }, { x: 300, y: 350 }, { x: 500, y: 200 }, { x: 700, y: 100 }]
        ];

        // Fonction preload: charger tous les assets (images, sprites) avant le jeu
        function preload() {
            this.load.image('sky', 'assets/sky.png'); // Charger l'image du ciel
            this.load.image('ground', 'assets/platform.png'); // Charger l'image des plateformes
            this.load.image('star', 'assets/piece.png', { frameWidth: 3, frameHeight: 3 });
            this.load.image('bomb', 'assets/bombe.png', { frameWidth: 3, frameHeight: 3 }); // Charger l'image des bombes
            this.load.image('vie', 'assets/vie1.png'); // Charger l'image des vies
            this.load.image('novie', 'assets/vie2.png'); // Charger l'image des vies perdues
            this.load.image('tremplin', 'assets/tremplin.png');
            this.load.spritesheet('dude', 'assets/personnageframe.png', { frameWidth: 32, frameHeight: 48 });
        }

        // Fonction create: initialiser les √©l√©ments du jeu une seule fois
        function create() {
            // Ajouter l'image du ciel en arri√®re-plan
            this.add.image(400, 300, 'sky');

            // Afficher le score en haut √† gauche
            scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });

            // Cr√©er les ic√¥nes de vies en haut √† gauche
            for (let i = 0; i < lives; i++) {
                let icon = this.add.image(40 + i * 45, 70, 'vie').setScale(0.02);
                lifeIcons.push(icon);
            }

            function createPlatformsForLevel(level) {

                // Supprimer anciennes plateformes
                platformsArray.forEach(p => p.destroy());
                platformsArray = [];

                // Supprimer le tremplin s‚Äôil existe
                if (tremplin) {
                    tremplin.destroy();
                    tremplin = null;
                }

                // Cr√©er plateformes du niveau
                platformLayouts[level].forEach(pos => {
                    platformsArray.push(platforms.create(pos.x, pos.y, 'ground'));
                });

                // Ajouter le tremplin UNIQUEMENT au level 8 (index 7)
                if (level === 1) {
                    tremplin = platforms.scene.physics.add.staticSprite(387, 514, 'tremplin');
                    tremplin.setScale(0.04);
                    tremplin.refreshBody();

                    // Collisions
                    platforms.scene.physics.add.collider(player, tremplin, bounceOnTrampoline, null, platforms.scene);
                    platforms.scene.physics.add.collider(stars, tremplin);
                    platforms.scene.physics.add.collider(bombs, tremplin);
                }
            }

            function bounceOnTrampoline(player, tremplin) {
                player.setVelocityY(-600); // saut puissant
            }

            // Cr√©er le groupe statique de plateformes
            platforms = this.physics.add.staticGroup();
            // Ajouter la plateforme du sol (ground)
            platforms.create(400, 568, 'ground').setScale(2).refreshBody();

            // Cr√©er les plateformes du niveau 0
            createPlatformsForLevel(0);

            // Cr√©er le personnage du joueur
            player = this.physics.add.sprite(100, 450, 'dude');
            player.setBounce(0.2); // Le personnage rebondit l√©g√®rement
            player.setCollideWorldBounds(true); // Le personnage ne peut pas sortir de l'√©cran

            // Cr√©er l'animation pour se d√©placer vers la gauche
            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
                frameRate: 10,
                repeat: -1
            });

            // Cr√©er l'animation pour √™tre immobile
            this.anims.create({
                key: 'turn',
                frames: [{ key: 'dude', frame: 4 }],
                frameRate: 20
            });

            // Cr√©er l'animation pour se d√©placer vers la droite
            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
                frameRate: 10,
                repeat: -1
            });

            // R√©cup√©rer les touches du clavier
            cursors = this.input.keyboard.createCursorKeys();

            // Cr√©er les √©toiles √† collecter
            stars = this.physics.add.group({ key: 'star', repeat: 11, setXY: { x: 12, y: 0, stepX: 70 } });
            stars.children.iterate(c => {
                c.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
                c.setScale(0.015); // üëà taille de l'√©toile
            });

            // Faire rebondir les √©toiles
            stars.children.iterate(c => c.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8)));

            // Cr√©er le groupe des bombes
            bombs = this.physics.add.group();

            // ===== Configurer les collisions et chevauchements =====
            this.physics.add.collider(player, platforms); // Le joueur collisionne avec les plateformes
            this.physics.add.collider(stars, platforms); // Les √©toiles collisionnent avec les plateformes
            this.physics.add.collider(bombs, platforms); // Les bombes collisionnent avec les plateformes
            this.physics.add.overlap(player, stars, collectStar, null, this); // Le joueur collecte les √©toiles
            this.physics.add.collider(player, bombs, hitBomb, null, this); // Le joueur touche une bombe
            this.physics.add.collider(stars, tremplin);
            this.physics.add.collider(bombs, tremplin);
            this.physics.add.collider(player, tremplin, bounceOnTrampoline, null, this);
        }

        // Fonction update: mise √† jour du jeu √† chaque frame
        function update() {
            // Si le jeu est fini, ne rien faire
            if (gameOver) return;

            // G√©rer les d√©placements du joueur avec les fl√®ches du clavier
            if (cursors.left.isDown) {
                player.setVelocityX(-160); // D√©placer vers la gauche
                player.anims.play('left', true);
            } else if (cursors.right.isDown) {
                player.setVelocityX(160); // D√©placer vers la droite
                player.anims.play('right', true);
            } else {
                player.setVelocityX(0); // Arr√™ter le mouvement horizontal
                player.anims.play('turn'); // Animation de repos
            }

            // Permettre au joueur de sauter s'il est sur une plateforme
            if (cursors.up.isDown && player.body.touching.down) {
                player.setVelocityY(-330); // Appliquer une v√©locit√© vers le haut
            }
        }

        // Fonction appel√©e quand le joueur collecte une √©toile
        function collectStar(player, star) {
            star.disableBody(true, true); // Supprimer l'√©toile
            score += 10; // Ajouter 10 points au score
            scoreText.setText('Score: ' + score); // Mettre √† jour l'affichage du score

            // V√©rifier si toutes les √©toiles ont √©t√© collect√©es
            if (stars.countActive(true) === 0) {
                changeLevel(); // Passer au niveau suivant

                // Cr√©er une nouvelle bombe de mani√®re al√©atoire
                let x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);
                let bomb = bombs.create(x, 16, 'bomb');
                // R√©duire la taille visuelle
                bomb.setScale(0.015);

                // Ajuster la hitbox √† la nouvelle taille
                bomb.body.setSize(
                    bomb.width * 0.015,
                    bomb.height * 0.015
                );
                bomb.body.setOffset(
                    bomb.width * 0.015,
                    bomb.height * 0.015
                );
                bomb.setBounce(1).setCollideWorldBounds(true); // La bombe rebondit
                bomb.setVelocity(Phaser.Math.Between(-200, 200), 20); // Donner une v√©locit√© al√©atoire

                // R√©activer toutes les √©toiles en haut de l'√©cran
                stars.children.iterate(c => c.enableBody(true, c.x, 0, true, true));
            }
        }

        // Fonction appel√©e quand le joueur touche une bombe
        function hitBomb(player, bomb) {
            bomb.disableBody(true, true); // Supprimer la bombe
            lives--; // R√©duire le nombre de vies

            // Masquer l'ic√¥ne de vie correspondante
            if (lives >= 0) {
                lifeIcons[lives]
                    .setTexture('novie')   // üëà remplace l‚Äôimage
                    .setScale(0.02);       // garde la m√™me taille
            }

            // V√©rifier si le joueur n'a plus de vies
            if (lives <= 0) {
                this.physics.pause(); // Arr√™ter la physique du jeu
                player.setTint(0xff0000); // Colorer le joueur en rouge
                player.anims.play('turn'); // Arr√™ter les animations
                gameOver = true; // Marquer le jeu comme termin√©
            }
        }

        // Fonction pour cr√©er les plateformes d'un niveau sp√©cifique
        function createPlatformsForLevel(level) {
            // Supprimer les anciennes plateformes
            platformsArray.forEach(p => p.destroy());
            platformsArray = [];

            // Cr√©er les nouvelles plateformes selon le layout du niveau
            platformLayouts[level].forEach(pos => {
                platformsArray.push(platforms.create(pos.x, pos.y, 'ground'));
            });
        }

        // Fonction pour passer au niveau suivant
        function changeLevel() {
            // Passer au niveau suivant (revenir au premier si on d√©passe le dernier)
            currentLevel = (currentLevel + 1) % platformLayouts.length;
            createPlatformsForLevel(currentLevel); // Cr√©er les plateformes du nouveau niveau
        }
    </script>
</body>

</html>